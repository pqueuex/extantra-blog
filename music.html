<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Music - EXTANTRA | Music Production & Audio Art</title>
    <meta name="description" content="Music productions and audio art by EXTANTRA. Explore electronic music, sound design, audio experiments, and musical compositions.">
    <meta name="keywords" content="music production, electronic music, sound design, audio art, music composition, EXTANTRA music">
    <meta name="author" content="EXTANTRA">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="bingbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    
    <!-- Open Graph Meta Tags for Social Media             loadSong(song) {
                console.log('Loading song into featured player:', song.title, 'File:', song.filename);
                this.currentSong = song;
                
                // Clear any existing event listeners
                const oldAudio = this.audio.cloneNode();
                this.audio.parentNode.replaceChild(oldAudio, this.audio);
                this.audio = oldAudio;
                
                // Set up event listeners
                this.audio.addEventListener('loadedmetadata', () => {
                    console.log('âœ“ Featured player metadata loaded');
                    this.updateDuration();
                });
                
                this.audio.addEventListener('canplay', () => {
                    console.log('âœ“ Featured player can play');
                });
                
                this.audio.addEventListener('error', (e) => {
                    console.error('âœ— Featured player audio error:', e);
                    console.error('Failed to load:', this.audio.src);
                });
                
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('ended', () => this.handleEnded());
                
                // Set the source and load
                this.audio.src = `audio/${song.filename}`;
                this.trackTitleEl.textContent = song.title;
                
                // Load the audio
                this.audio.load();
                
                console.log('Song loaded and ready to play');
            } property="og:title" content="Music - EXTANTRA">
    <meta property="og:description" content="Music productions and audio art by EXTANTRA.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://extantra.net/music.html">
    <meta property="og:image" content="https://extantra.net/images/extantralogo-inverted.webp">
    <meta property="og:site_name" content="EXTANTRA Blog">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Music - EXTANTRA">
    <meta name="twitter:description" content="Music productions and audio art by EXTANTRA.">
    <meta name="twitter:image" content="https://extantra.net/images/extantralogo-inverted.webp">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://extantra.net/music.html">
    
    <!-- Favicon -->
    <link rel="icon" type="image/webp" href="images/extantralogo-inverted.webp">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-space">
                <img src="images/extantralogo-inverted.webp" alt="EXTANTRA Logo" class="logo-image">
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar">
                <div class="categories-section">
                    <div class="category" onclick="goToPage('index.html')">Home</div>
                    <div class="category" onclick="goToPage('photos.html')">Photos</div>
                    <div class="category" onclick="goToPage('3d-models.html')">3D Models</div>
                    <div class="category" onclick="goToPage('video.html')">Video</div>
                    <div class="category" onclick="goToPage('drawings.html')">Drawings</div>
                    <div class="category active" onclick="goToPage('music.html')">Music</div>
                </div>
            </aside>

            <main class="content">
                <div class="content-header">
                    <h1>Music</h1>
                    <p class="tagline">Art Between 20 Hz & 20 kHz</p>
                </div>

                <!-- Featured Music Player -->
                <div class="featured-player">
                    <audio id="featuredAudio" preload="metadata"></audio>
                    <div class="player-header">
                        <h3>Featured Track</h3>
                        <span class="track-title" id="featuredTrackTitle">Select a song to play</span>
                    </div>
                    <div class="player-controls">
                        <div class="controls-left">
                            <button class="play-pause-btn" id="featuredPlayPauseBtn">
                                <svg class="play-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                                <svg class="pause-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                </svg>
                            </button>
                            <div class="volume-control" id="volumeControl">
                                <svg class="volume-knob" width="28" height="28" viewBox="0 0 28 28">
                                    <circle cx="14" cy="14" r="11" fill="none" stroke="#333" stroke-width="1" class="volume-track"/>
                                    <circle cx="14" cy="14" r="11" fill="none" stroke="#cc0000" stroke-width="2" 
                                            stroke-dasharray="69.12" stroke-dashoffset="69.12" 
                                            transform="rotate(-90 14 14)" class="volume-fill" id="volumeFill"/>
                                </svg>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" id="featuredProgressBar">
                                <div class="progress-fill" id="featuredProgressFill"></div>
                                <div class="progress-handle" id="featuredProgressHandle"></div>
                                <canvas class="visualizer" id="featuredVisualizer"></canvas>
                            </div>
                            <div class="time-display">
                                <span id="featuredCurrentTime">0:00</span>
                                <span id="featuredDuration">0:00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Songs List -->
                <div class="songs-section">
                    <div class="section-header">
                        <h2>Music Collection</h2>
                        <div class="genre-filter">
                            <button class="filter-btn active" data-genre="all">All</button>
                            <button class="filter-btn" data-genre="Electronic">Electronic</button>
                            <button class="filter-btn" data-genre="Ambient">Ambient</button>
                            <button class="filter-btn" data-genre="Emo">Emo</button>
                            <button class="filter-btn" data-genre="Experimental">Experimental</button>
                        </div>
                    </div>
                    <div class="songs-grid" id="songsGrid">
                        <!-- Songs will be loaded here dynamically -->
                    </div>
                </div>
            </main>
        </div>

        <footer class="footer">
            <div class="footer-content">
                <p>&copy; 2025 EXTANTRA. All rights reserved.</p>
                <div class="footer-links">
                    <a href="mailto:contact@extantra.net">Contact</a>
                    <a href="https://store.extantra.net">Store</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        function goToPage(page) {
            window.location.href = page;
        }

        // Music Database and Player System
        class MusicLibrary {
            constructor() {
                this.songs = [];
                this.currentSong = null;
                this.featuredPlayer = null;
                this.songPlayers = new Map();
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                
                this.init();
            }
            
            async init() {
                console.log('Initializing MusicLibrary...');
                await this.loadSongsDatabase();
                console.log('Database loaded, setting up featured player...');
                this.setupFeaturedPlayer();
                console.log('Featured player setup, rendering songs...');
                this.renderSongs();
                console.log('Songs rendered, setting up genre filter...');
                this.setupGenreFilter();
                console.log('Genre filter setup, setting up audio context...');
                this.setupAudioContext();
                console.log('MusicLibrary initialization complete!');
                
                // Load metadata in the background
                this.loadMetadataInBackground();
            }
            
            async loadMetadataInBackground() {
                console.log('Loading metadata in background...');
                for (let song of this.songs) {
                    try {
                        console.log(`Loading metadata for: ${song.title}`);
                        await this.loadSongMetadata(song);
                        console.log(`Metadata loaded for ${song.title}: ${song.duration}`);
                        
                        // Update the duration display when metadata loads
                        const durationEl = document.querySelector(`.song-card[data-genre="${song.genre}"] .song-duration[data-song-id="${song.id}"]`);
                        if (durationEl) {
                            durationEl.textContent = song.duration;
                            console.log(`Updated duration display for ${song.title}: ${song.duration}`);
                        } else {
                            // Try alternative selector
                            const allDurationEls = document.querySelectorAll('.song-duration');
                            const matchingEl = Array.from(allDurationEls).find(el => el.dataset.songId === song.id.toString());
                            if (matchingEl) {
                                matchingEl.textContent = song.duration;
                                console.log(`Updated duration display (alt method) for ${song.title}: ${song.duration}`);
                            } else {
                                console.warn(`Could not find duration element for ${song.title} (ID: ${song.id})`);
                            }
                        }
                    } catch (error) {
                        console.error(`Error loading metadata for ${song.title}:`, error);
                    }
                }
            }
            
            async loadSongsDatabase() {
                try {
                    console.log('Loading songs database...');
                    
                    // Only fetch if using HTTP/HTTPS to avoid CORS errors on file://
                    if (window.location.protocol.startsWith('http')) {
                        const response = await fetch('songs-database.json');
                        console.log('Response status:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('Loaded songs data from JSON file:', data);
                        this.songs = data.songs;
                    } else {
                        console.log('Running on file:// protocol. Skipping fetch and using embedded data.');
                        throw new Error('Using embedded data due to file:// protocol.');
                    }
                } catch (error) {
                    console.warn('Could not load from JSON, using embedded data:', error.message);
                    // Embedded fallback data
                    this.songs = [
                        {
                            id: 1,
                            title: "5796709888",
                            filename: "5796709888.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Original electronic composition"
                        },
                        {
                            id: 2,
                            title: "A White Dress",
                            filename: "a white dress.mp3",
                            artist: "EXTANTRA",
                            genre: "Ambient",
                            duration: "0:00",
                            description: "Atmospheric ambient piece"
                        },
                        {
                            id: 3,
                            title: "Bad",
                            filename: "bad.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Dark electronic track"
                        },
                        {
                            id: 4,
                            title: "Beggo",
                            filename: "beggo.mp3",
                            artist: "EXTANTRA",
                            genre: "Experimental",
                            duration: "0:00",
                            description: "Experimental composition"
                        },
                        {
                            id: 5,
                            title: "Britmix",
                            filename: "britmix.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "British-inspired electronic mix"
                        },
                        {
                            id: 6,
                            title: "Emo1",
                            filename: "emo1.mp3",
                            artist: "EXTANTRA",
                            genre: "Emo",
                            duration: "0:00",
                            description: "Emotional electronic piece"
                        },
                        {
                            id: 7,
                            title: "Emosong1",
                            filename: "emosong1.mp3",
                            artist: "EXTANTRA",
                            genre: "Emo",
                            duration: "0:00",
                            description: "Emotional composition"
                        },
                        {
                            id: 8,
                            title: "Endleton",
                            filename: "endleton.mp3",
                            artist: "EXTANTRA",
                            genre: "Ambient",
                            duration: "0:00",
                            description: "Atmospheric soundscape"
                        },
                        {
                            id: 9,
                            title: "Gmode",
                            filename: "gmode.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Gaming-inspired electronic track"
                        },
                        {
                            id: 10,
                            title: "Gog1",
                            filename: "gog1.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Electronic composition"
                        },
                        {
                            id: 11,
                            title: "Gooup1",
                            filename: "gooup1.mp3",
                            artist: "EXTANTRA",
                            genre: "Upbeat",
                            duration: "0:00",
                            description: "Uplifting electronic track"
                        },
                        {
                            id: 12,
                            title: "Grilla",
                            filename: "grilla.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Intense electronic composition"
                        },
                        {
                            id: 13,
                            title: "Grisp",
                            filename: "grisp.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Crisp electronic sounds"
                        },
                        {
                            id: 14,
                            title: "Hungg",
                            filename: "hungg.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Heavy electronic piece"
                        },
                        {
                            id: 15,
                            title: "If You Don't (Mix)",
                            filename: "ifyoudonMIXt.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Mixed electronic composition"
                        },
                        {
                            id: 16,
                            title: "Iron Sight",
                            filename: "ironsight.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Gaming-inspired electronic track"
                        },
                        {
                            id: 17,
                            title: "Maby",
                            filename: "maby.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Contemplative electronic piece"
                        },
                        {
                            id: 18,
                            title: "Olive Tree",
                            filename: "olivetree.mp3",
                            artist: "EXTANTRA",
                            genre: "Ambient",
                            duration: "0:00",
                            description: "Nature-inspired ambient composition"
                        },
                        {
                            id: 19,
                            title: "Organ Pie",
                            filename: "organpie.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Organ-based electronic track"
                        },
                        {
                            id: 20,
                            title: "P1",
                            filename: "p1.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Electronic composition part 1"
                        },
                        {
                            id: 21,
                            title: "Pall",
                            filename: "pall.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Dark electronic piece"
                        },
                        {
                            id: 22,
                            title: "Partin",
                            filename: "partin.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Departure-themed composition"
                        },
                        {
                            id: 23,
                            title: "Punkt",
                            filename: "punkt.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Pointillistic electronic composition"
                        },
                        {
                            id: 24,
                            title: "RP",
                            filename: "rp.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Electronic track"
                        },
                        {
                            id: 25,
                            title: "Rusicri",
                            filename: "rusicri.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Crisp electronic composition"
                        },
                        {
                            id: 26,
                            title: "Skid",
                            filename: "skid.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Fast-paced electronic track"
                        },
                        {
                            id: 27,
                            title: "Solid",
                            filename: "solid.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Solid electronic composition"
                        },
                        {
                            id: 28,
                            title: "Te",
                            filename: "te.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Minimal electronic piece"
                        },
                        {
                            id: 29,
                            title: "Uneven (Mix)",
                            filename: "unevenMIX.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Asymmetrical electronic mix"
                        },
                        {
                            id: 30,
                            title: "Viol",
                            filename: "viol.mp3",
                            artist: "EXTANTRA",
                            genre: "Electronic",
                            duration: "0:00",
                            description: "Violin-inspired electronic composition"
                        }
                    ];
                }
                
                console.log('Songs array:', this.songs);
                console.log('Songs loaded successfully, metadata will load in background');
            }
            
            async loadSongMetadata(song) {
                return new Promise((resolve) => {
                    console.log(`Creating audio element for ${song.filename}`);
                    const audio = new Audio();
                    
                    const cleanup = () => {
                        audio.removeEventListener('loadedmetadata', onLoaded);
                        audio.removeEventListener('error', onError);
                        audio.removeEventListener('canplaythrough', onCanPlay);
                    };
                    
                    const onLoaded = () => {
                        console.log(`Metadata loaded for ${song.filename}, duration: ${audio.duration}`);
                        if (audio.duration && !isNaN(audio.duration) && isFinite(audio.duration)) {
                            song.duration = this.formatTime(audio.duration);
                        } else {
                            song.duration = '0:00';
                        }
                        cleanup();
                        resolve();
                    };
                    
                    const onCanPlay = () => {
                        console.log(`Can play ${song.filename}, duration: ${audio.duration}`);
                        if (audio.duration && !isNaN(audio.duration) && isFinite(audio.duration)) {
                            song.duration = this.formatTime(audio.duration);
                        }
                        cleanup();
                        resolve();
                    };
                    
                    const onError = (e) => {
                        console.error(`Error loading ${song.filename}:`, e);
                        song.duration = '0:00';
                        cleanup();
                        resolve();
                    };
                    
                    audio.addEventListener('loadedmetadata', onLoaded);
                    audio.addEventListener('canplaythrough', onCanPlay);
                    audio.addEventListener('error', onError);
                    
                    // Set a timeout to avoid hanging
                    setTimeout(() => {
                        console.warn(`Timeout loading metadata for ${song.filename}`);
                        if (song.duration === '0:00') {
                            cleanup();
                            resolve();
                        }
                    }, 5000);
                    
                    // Start loading
                    audio.src = `audio/${song.filename}`;
                    audio.load();
                });
            }
            
            setupFeaturedPlayer() {
                this.featuredPlayer = new FeaturedMusicPlayer();
            }
            
            setupAudioContext() {
                // Don't even try if on file:// protocol, it will fail and silence the audio element.
                if (!window.location.protocol.startsWith('http')) {
                    console.log('On file:// protocol, skipping Web Audio API setup. Using fallback visualizer.');
                    this.useRealVisualizer = false;
                    return;
                }

                // Idempotent setup: only run once.
                if (this.audioContext) {
                    return;
                }
                
                try {
                    console.log('Attempting to create AudioContext and connect audio graph...');
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    
                    // Optimized for bass-heavy music
                    this.analyser.fftSize = 512;
                    this.analyser.smoothingTimeConstant = 0.3;
                    this.analyser.minDecibels = -100;
                    this.analyser.maxDecibels = -10;
                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    
                    // Create the source node ONCE and connect the graph.
                    this.source = this.audioContext.createMediaElementSource(this.audio);
                    this.source.connect(this.analyser);
                    this.analyser.connect(this.audioContext.destination);
                    
                    console.log('âœ… Web Audio API connected successfully. Real visualizer enabled.');
                    this.useRealVisualizer = true;
                    
                } catch (error) {
                    console.warn('Web Audio API setup failed. Using fallback visualizer.', error);
                    this.useRealVisualizer = false;
                }
            }
            
            createFallbackSongs() {
                // Create fallback songs from your audio files
                const audioFiles = [
                    '5796709888.mp3', 'a white dress.mp3', 'bad.mp3', 'beggo.mp3', 'britmix.mp3',
                    'emo1.mp3', 'emosong1.mp3', 'endleton.mp3', 'gmode.mp3', 'gog1.mp3',
                    'gooup1.mp3', 'grilla.mp3', 'grisp.mp3', 'hungg.mp3', 'ifyoudonMIXt.mp3',
                    'ironsight.mp3', 'maby.mp3', 'olivetree.mp3', 'organpie.mp3', 'p1.mp3',
                    'pall.mp3', 'partin.mp3', 'punkt.mp3', 'rp.mp3', 'rusicri.mp3',
                    'skid.mp3', 'solid.mp3', 'te.mp3', 'unevenMIX.mp3', 'viol.mp3'
                ];
                
                return audioFiles.map((filename, index) => ({
                    id: index + 1,
                    title: filename.replace('.mp3', '').replace(/([a-z])([A-Z])/g, '$1 $2'),
                    filename: filename,
                    artist: 'EXTANTRA',
                    genre: 'Electronic',
                    duration: '0:00',
                    description: 'Original composition by EXTANTRA'
                }));
            }
            
            renderSongs() {
                console.log('Rendering songs...', this.songs.length, 'songs found');
                const songsGrid = document.getElementById('songsGrid');
                
                if (!songsGrid) {
                    console.error('Songs grid element not found!');
                    return;
                }
                
                songsGrid.innerHTML = '';
                
                if (this.songs.length === 0) {
                    songsGrid.innerHTML = '<p style="color: #ccc; text-align: center; padding: 20px;">No songs found. Check console for errors.</p>';
                    return;
                }
                
                this.songs.forEach(song => {
                    console.log('Creating card for song:', song.title);
                    const songCard = this.createSongCard(song);
                    songsGrid.appendChild(songCard);
                });
                
                console.log('Finished rendering', this.songs.length, 'songs');
            }
            
            createSongCard(song) {
                const card = document.createElement('div');
                card.className = 'song-card';
                card.dataset.genre = song.genre;
                
                card.innerHTML = `
                    <div class="song-line">
                        <div class="song-info">
                            <span class="song-title">${song.title}</span>
                            <span class="song-meta">
                                <span class="song-genre">${song.genre}</span>
                                <span class="song-duration" data-song-id="${song.id}">${song.duration}</span>
                            </span>
                        </div>
                        <button class="load-to-featured-btn" data-song-id="${song.id}">
                            Load
                        </button>
                    </div>
                `;
                
                // Setup song card event listeners
                this.setupSongCardEvents(card, song);
                
                return card;
            }
            
            setupSongCardEvents(card, song) {
                const loadBtn = card.querySelector('.load-to-featured-btn');
                loadBtn.addEventListener('click', () => this.loadToFeaturedPlayer(song));
            }
            
            loadToFeaturedPlayer(song) {
                console.log('ðŸŽ¶ loadToFeaturedPlayer() called with song:', song.title);
                console.log('Featured player exists:', !!this.featuredPlayer);
                console.log('Featured player loadSong method exists:', !!this.featuredPlayer?.loadSong);
                
                if (this.featuredPlayer && this.featuredPlayer.loadSong) {
                    this.featuredPlayer.loadSong(song);
                } else {
                    console.error('âŒ Featured player or loadSong method not available');
                }
            }
            
            setupGenreFilter() {
                const filterButtons = document.querySelectorAll('.filter-btn');
                filterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // Update active button
                        filterButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        
                        // Filter songs
                        const genre = button.dataset.genre;
                        this.filterSongsByGenre(genre);
                    });
                });
            }
            
            filterSongsByGenre(genre) {
                const songCards = document.querySelectorAll('.song-card');
                songCards.forEach(card => {
                    if (genre === 'all' || card.dataset.genre === genre) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
            
            formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        // Featured Music Player Class
        class FeaturedMusicPlayer {
            constructor() {
                this.audio = document.getElementById('featuredAudio');
                this.playPauseBtn = document.getElementById('featuredPlayPauseBtn');
                this.progressBar = document.getElementById('featuredProgressBar');
                this.progressFill = document.getElementById('featuredProgressFill');
                this.progressHandle = document.getElementById('featuredProgressHandle');
                this.currentTimeEl = document.getElementById('featuredCurrentTime');
                this.durationEl = document.getElementById('featuredDuration');
                this.trackTitleEl = document.getElementById('featuredTrackTitle');
                this.canvas = document.getElementById('featuredVisualizer');
                this.ctx = this.canvas.getContext('2d');
                this.playIcon = document.querySelector('#featuredPlayPauseBtn .play-icon');
                this.pauseIcon = document.querySelector('#featuredPlayPauseBtn .pause-icon');
                
                // Volume control elements
                this.volumeControl = document.getElementById('volumeControl');
                this.volumeFill = document.getElementById('volumeFill');
                this.isDraggingVolume = false;
                this.volume = 1.0; // Default volume (100%)
                
                this.currentSong = null;
                this.isPlaying = false;
                this.isDragging = false;
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                this.source = null;
                this.useRealVisualizer = false;
                this.fakeVisualizerData = [];
                
                this.initializeFakeVisualizer();
                this.setupEventListeners();
                this.animate();
                
                // Initialize volume display
                this.updateVolumeDisplay();
            }
            
            setupEventListeners() {
                this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                this.audio.addEventListener('loadedmetadata', () => this.updateDuration());
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('ended', () => this.handleEnded());
                
                this.progressBar.addEventListener('mousedown', (e) => this.startDrag(e));
                document.addEventListener('mousemove', (e) => this.drag(e));
                document.addEventListener('mouseup', () => this.endDrag());
                
                // Volume control event listeners
                this.volumeControl.addEventListener('mousedown', (e) => this.startVolumeControl(e));
                document.addEventListener('mousemove', (e) => this.dragVolume(e));
                document.addEventListener('mouseup', () => this.endVolumeControl());
            }
            
            loadSong(song) {
                console.log('ðŸŽµ Loading song:', song.title);
                this.currentSong = song;
                this.audio.src = `audio/${song.filename}`;
                this.trackTitleEl.textContent = song.title;
                
                this.isPlaying = false;
                this.playIcon.style.display = 'block';
                this.pauseIcon.style.display = 'none';
                
                // Set initial volume
                this.audio.volume = this.volume;
                this.updateVolumeDisplay();
                
                // Explicitly load the audio. The existing audio graph will pick it up.
                this.audio.load();
            }
            
            setupAudioContext() {
                // Don't even try if on file:// protocol, it will fail and silence the audio element.
                if (!window.location.protocol.startsWith('http')) {
                    console.log('On file:// protocol, skipping Web Audio API setup. Using fallback visualizer.');
                    this.useRealVisualizer = false;
                    return;
                }

                // Idempotent setup: only run once.
                if (this.audioContext) {
                    return;
                }
                
                try {
                    console.log('Attempting to create AudioContext and connect audio graph...');
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    
                    // Optimized for bass-heavy music
                    this.analyser.fftSize = 512;
                    this.analyser.smoothingTimeConstant = 0.3;
                    this.analyser.minDecibels = -100;
                    this.analyser.maxDecibels = -10;
                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    
                    // Create the source node ONCE and connect the graph.
                    this.source = this.audioContext.createMediaElementSource(this.audio);
                    this.source.connect(this.analyser);
                    this.analyser.connect(this.audioContext.destination);
                    
                    console.log('âœ… Web Audio API connected successfully. Real visualizer enabled.');
                    this.useRealVisualizer = true;
                    
                } catch (error) {
                    console.warn('Web Audio API setup failed. Using fallback visualizer.', error);
                    this.useRealVisualizer = false;
                }
            }
            
            togglePlayPause() {
                if (!this.currentSong) return;
                
                if (this.isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
            }
            
            async play() {
                if (!this.currentSong) {
                    console.warn('No song loaded');
                    return;
                }
                
                try {
                    console.log('â–¶ï¸ Playing:', this.currentSong.title);
                    
                    // Set up Web Audio API. This is idempotent and will only run once.
                    this.setupAudioContext();
                    
                    // Resume audio context if suspended (required by browsers)
                    if (this.audioContext && this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                        console.log('Audio context resumed');
                    }
                    
                    // Play the audio
                    await this.audio.play();
                    
                    this.isPlaying = true;
                    this.playIcon.style.display = 'none';
                    this.pauseIcon.style.display = 'block';
                    
                    if (this.useRealVisualizer) {
                        console.log('âœ… Audio playing with real visualizer');
                    } else {
                        console.log('âœ… Audio playing with fake visualizer');
                    }
                } catch (error) {
                    console.error('âŒ Error playing audio:', error);
                }
            }
            
            pause() {
                this.audio.pause();
                this.isPlaying = false;
                this.playIcon.style.display = 'block';
                this.pauseIcon.style.display = 'none';
            }
            
            handleEnded() {
                this.isPlaying = false;
                this.playIcon.style.display = 'block';
                this.pauseIcon.style.display = 'none';
            }
            
            updateDuration() {
                this.durationEl.textContent = this.formatTime(this.audio.duration);
            }
            
            updateProgress() {
                if (!this.isDragging && this.audio.duration) {
                    const progress = (this.audio.currentTime / this.audio.duration) * 100;
                    this.progressFill.style.width = `${progress}%`;
                    this.progressHandle.style.left = `${progress}%`;
                    this.currentTimeEl.textContent = this.formatTime(this.audio.currentTime);
                }
            }
            
            startDrag(e) {
                this.isDragging = true;
                this.updateProgressFromMouse(e);
            }
            
            drag(e) {
                if (this.isDragging) {
                    this.updateProgressFromMouse(e);
                }
            }
            
            endDrag() {
                this.isDragging = false;
            }
            
            startVolumeControl(e) {
                e.preventDefault();
                this.isDraggingVolume = true;
                this.updateVolumeFromMouse(e);
            }
            
            dragVolume(e) {
                if (this.isDraggingVolume) {
                    this.updateVolumeFromMouse(e);
                }
            }
            
            endVolumeControl() {
                this.isDraggingVolume = false;
            }
            
            updateVolumeFromMouse(e) {
                const rect = this.volumeControl.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                // Calculate angle from center
                const deltaX = e.clientX - centerX;
                const deltaY = e.clientY - centerY;
                let angle = Math.atan2(deltaY, deltaX);
                
                // Convert to 0-360 degrees, starting from top
                angle = (angle * 180 / Math.PI + 450) % 360;
                
                // Map angle to volume (0-100%)
                let volume = Math.max(0, Math.min(1, angle / 360));
                
                this.volume = volume;
                this.audio.volume = volume;
                this.updateVolumeDisplay();
            }
            
            updateVolumeDisplay() {
                // Calculate stroke-dashoffset for the ring (circumference â‰ˆ 69.12 for r=11)
                const circumference = 69.12;
                const offset = circumference - (this.volume * circumference);
                this.volumeFill.style.strokeDashoffset = offset;
            }
            
            updateProgressFromMouse(e) {
                const rect = this.progressBar.getBoundingClientRect();
                const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                
                this.progressFill.style.width = `${percent * 100}%`;
                this.progressHandle.style.left = `${percent * 100}%`;
                
                if (this.audio.duration) {
                    this.audio.currentTime = percent * this.audio.duration;
                }
            }
            
            // Volume control methods
            startVolumeDrag(e) {
                this.isDraggingVolume = true;
                this.updateVolumeFromMouse(e);
            }
            
            volumeDrag(e) {
                if (this.isDraggingVolume) {
                    this.updateVolumeFromMouse(e);
                }
            }
            
            endVolumeDrag() {
                this.isDraggingVolume = false;
            }
            
            animate() {
                const rect = this.canvas.getBoundingClientRect();
                if (rect.width !== this.canvas.width || rect.height !== this.canvas.height) {
                    this.canvas.width = rect.width;
                    this.canvas.height = rect.height;
                }
                
                this.drawVisualizer();
                requestAnimationFrame(() => this.animate());
            }
            
            drawVisualizer() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                let visualizerData;
                
                if (this.useRealVisualizer && this.analyser && this.isPlaying) {
                    this.analyser.getByteFrequencyData(this.dataArray);
                    visualizerData = this.dataArray;
                } else {
                    this.updateFakeVisualizer();
                    visualizerData = this.fakeVisualizerData;
                }
                
                if (!this.isPlaying && this.fakeVisualizerData.every(d => d < 1)) {
                    return;
                }
                
                const numBars = Math.min(this.canvas.width / 2, 200);
                const barWidth = 1;
                const barSpacing = this.canvas.width / numBars;
                
                for (let i = 0; i < numBars; i++) {
                    const dataIndex = Math.floor((i / numBars) * (visualizerData.length * 0.5)); // Use first 50% of spectrum
                    let barHeight = (visualizerData[dataIndex] / 255) * this.canvas.height;
                    
                    if (i < numBars * 0.3) {
                        barHeight *= 1.5;
                    }
                    
                    barHeight = Math.max(barHeight, 2);
                    barHeight = Math.min(barHeight, this.canvas.height - 2);
                    
                    const x = i * barSpacing;
                    
                    this.ctx.fillStyle = '#cc0000';
                    this.ctx.fillRect(x, this.canvas.height - barHeight, barWidth, barHeight);
                }
            }
            
            initializeFakeVisualizer() {
                this.fakeVisualizerData = new Array(256).fill(0);
            }
            
            updateFakeVisualizer() {
                if (!this.isPlaying) {
                    for (let i = 0; i < this.fakeVisualizerData.length; i++) {
                        this.fakeVisualizerData[i] *= 0.95;
                    }
                    return;
                }
                
                const time = Date.now() * 0.005;
                
                for (let i = 0; i < this.fakeVisualizerData.length; i++) {
                    const freq = i / this.fakeVisualizerData.length;
                    let target;
                    
                    if (freq < 0.3) {
                        const bassWave = Math.sin(time + i * 0.1) * 0.8;
                        const bassNoise = (Math.random() - 0.5) * 0.4;
                        target = Math.max(0, 80 + bassWave * 60 + bassNoise * 30);
                        this.fakeVisualizerData[i] += (target - this.fakeVisualizerData[i]) * 0.1;
                    } else if (freq < 0.7) {
                        const midWave = Math.sin(time * 1.5 + i * 0.2) * 0.6;
                        const midNoise = (Math.random() - 0.5) * 0.6;
                        target = Math.max(0, 40 + midWave * 40 + midNoise * 20);
                        this.fakeVisualizerData[i] += (target - this.fakeVisualizerData[i]) * 0.15;
                    } else {
                        const highWave = Math.sin(time * 3 + i * 0.5) * 0.4;
                        const highNoise = (Math.random() - 0.5) * 0.8;
                        target = Math.max(0, 20 + highWave * 30 + highNoise * 25);
                        this.fakeVisualizerData[i] += (target - this.fakeVisualizerData[i]) * 0.3;
                    }
                    
                    this.fakeVisualizerData[i] = Math.max(0, Math.min(255, this.fakeVisualizerData[i]));
                }
            }
        }
        
        // Initialize the music library when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing music library...');
            
            const musicLibrary = new MusicLibrary();
            // Make featured player globally accessible for debugging
            window.featuredPlayer = musicLibrary.featuredPlayer;
        });
    </script>
</body>
</html>
